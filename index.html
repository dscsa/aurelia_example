<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <app-root></app-root>
    <script type="module">
      import { Aurelia, RouterConfiguration, Route, CustomElement } from 'https://cdn.jsdelivr.net/npm/aurelia/dist/native-modules/index.js';
      import { Routes } from './src/routes/index.js';
      import { Components } from './src/components/index.js';
      import { AppRoot } from './src/root/app-root.js';

      async function importAuElement(elemName, path) {
        const html = await fetch(`src/${path}/${elemName}.html`);
        return await html.text();
      }

      async function registerAuElements(elementClasses, path) {
        const htmlStrings = await Promise.all(elementClasses.map((elementClass) => importAuElement(elementClass.name, path)));
        return elementClasses.map((elementClass, i) => {
          const html = htmlStrings[i];
          return (
            CustomElement.define({
              name: elementClass.name,
              template: html,
              bindables: elementClass.bindables,
              watches: elementClass.watches
            }, elementClass)
          );
        });
      }

      async function start() {
        const au = new Aurelia();
        au.register(
          RouterConfiguration.customize({
            useUrlFragmentHash: false,
          }),
        );

        const elements = await registerAuElements(Components, 'components');
        elements.map(element => au.register(element));

        const routeElements = await registerAuElements(Routes, 'routes');
        const routes = Routes.map(route => {
          au.register(route);
          return { id: route.name, path: route.path, title: route.title, component: route };
        });


        const RootHtml = await importAuElement(AppRoot.name, 'root');
        const Root = CustomElement.define({
          name: AppRoot.name,
          template: RootHtml,
        }, AppRoot);

        Route.configure({
          routes
        }, Root);

        au.app({
          component: Root,
          host: document.querySelector(AppRoot.name),
        });

        au.start();
      }
      start();
    </script>
  </body>
</html>
